name: Daily AstroFinance Content Generator

on:
  schedule:
#    - cron: '0 8 * * *'  # Daily at 8 AM UTC
#  workflow_dispatch:  # Manual trigger

permissions:
  contents: write

jobs:
  generate-and-upload:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2 hours for video generation

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Set up Python
      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 3Ô∏è‚É£ Install system dependencies
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg imagemagick
          
      # 4Ô∏è‚É£ Fix ImageMagick security policy
      - name: Fix ImageMagick policy
        run: |
          sudo sed -i '/<policy domain="path" rights="none" pattern="@\*"/d' /etc/ImageMagick-6/policy.xml

      # 5Ô∏è‚É£ Cache pip packages
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # 6Ô∏è‚É£ Install Python dependencies
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install moviepy==1.0.3 gTTS requests Pillow imageio imageio-ffmpeg pyyaml
          pip install google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client
          echo "Installed packages:"
          pip list | grep -E "(moviepy|gTTS|requests|Pillow|imageio|yaml)"

      # 7Ô∏è‚É£ Verify installations
      - name: Verify installations
        run: |
          echo "Checking installations..."
          python -c "import moviepy; print('‚úÖ MoviePy:', moviepy.__version__)"
          python -c "import yaml; print('‚úÖ PyYAML:', yaml.__version__)" || echo "‚ö†Ô∏è PyYAML check failed, trying to install..."
          pip install pyyaml --force-reinstall
          python -c "import yaml; print('‚úÖ PyYAML:', yaml.__version__)"
          python -c "from gtts import gTTS; print('‚úÖ gTTS installed')"
          python -c "from PIL import Image; print('‚úÖ Pillow installed')"
          ffmpeg -version | head -n 1

      # 8Ô∏è‚É£ Verify media files exist
      - name: Check media files
        run: |
          echo "Checking for required media files..."
          
          if [ -f "background.mp4" ]; then
            echo "‚úÖ background.mp4 found"
            ls -lh background.mp4
          else
            echo "‚ö†Ô∏è background.mp4 NOT found! Creating placeholder..."
            python -c "
          from moviepy.editor import ColorClip
          clip = ColorClip(size=(1080, 1920), color=(10, 10, 40), duration=60)
          clip.write_videofile('background.mp4', fps=30, codec='libx264', audio=False, logger=None)
          print('‚úÖ Placeholder background created')
            "
          fi
          
          if [ -f "om_mantra.mp3" ]; then
            echo "‚úÖ om_mantra.mp3 found"
            ls -lh om_mantra.mp3
          else
            echo "‚ö†Ô∏è om_mantra.mp3 NOT found! Creating silent placeholder..."
            python -c "
          from moviepy.editor import AudioClip
          audio = AudioClip(lambda t: 0, duration=300, fps=44100)
          audio.write_audiofile('om_mantra.mp3', logger=None)
          print('‚ö†Ô∏è Replace with real OM Mantra audio for better videos!')
            "
          fi
          
          echo ""
          echo "üìÅ All media files ready!"

      # 9Ô∏è‚É£ Generate videos
      - name: Generate daily content
        env:
          HUGGINGFACE_API_KEY: ${{ secrets.HUGGINGFACE_API_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          echo "üé¨ Starting FREE content generation..."
          python main.py

      # üîü Upload step is DISABLED (manual upload only)
      - name: Upload to social media
        if: false  # DISABLED - videos saved to Artifacts instead
        run: |
          echo "‚ö†Ô∏è Auto-upload disabled"
          echo "üì• Download videos from Artifacts and upload manually to YouTube"

      # 1Ô∏è‚É£1Ô∏è‚É£ Upload videos as GitHub Artifacts (this is where they go!)
      - name: Upload generated videos to GitHub Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: astrofinance-videos-${{ github.run_number }}
          path: videos/youtube_shorts/
          retention-days: 7

      # 1Ô∏è‚É£2Ô∏è‚É£ Upload metadata (only if exists)
      - name: Upload metadata
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: metadata-${{ github.run_number }}
          path: videos/youtube_shorts/*.mp4
          retention-days: 7
          if-no-files-found: warn

      # 1Ô∏è‚É£3Ô∏è‚É£ Clean up temp files
      - name: Cleanup
        if: always()
        run: |
          rm -rf temp/
          echo "‚úÖ Cleanup complete"

      # 1Ô∏è‚É£4Ô∏è‚É£ Summary
      - name: Workflow summary
        if: always()
        run: |
          echo "## üåü AstroFinance Daily Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìÖ **Date:** $(date +'%B %d, %Y')" >> $GITHUB_STEP_SUMMARY
          echo "‚è∞ **Run Time:** $(date +'%H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "videos/metadata.json" ]; then
            echo "‚úÖ **Videos Generated Successfully**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üì∫ YouTube long-form video: Ready" >> $GITHUB_STEP_SUMMARY
            echo "üì± Short-form content: Ready" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Video Generation Failed**" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üì• **Download videos from Artifacts section below**" >> $GITHUB_STEP_SUMMARY
