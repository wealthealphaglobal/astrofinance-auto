name: Daily AstroFinance Content Generator

on:
  schedule:
    - cron: '0 8 * * *'  # Daily at 8 AM UTC
  workflow_dispatch:  # Manual trigger

permissions:
  contents: write

jobs:
  generate-and-upload:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2 hours for video generation

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Set up Python
      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 3Ô∏è‚É£ Install system dependencies
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg imagemagick
          
      # 4Ô∏è‚É£ Fix ImageMagick security policy
      - name: Fix ImageMagick policy
        run: |
          sudo sed -i '/<policy domain="path" rights="none" pattern="@\*"/d' /etc/ImageMagick-6/policy.xml

      # 5Ô∏è‚É£ Cache pip packages
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # 6Ô∏è‚É£ Install Python dependencies
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install moviepy==1.0.3 gTTS requests Pillow imageio imageio-ffmpeg pyyaml
          pip install google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client
          echo "Installed packages:"
          pip list | grep -E "(moviepy|gTTS|requests|Pillow|imageio|yaml)"

      # 7Ô∏è‚É£ Verify installations
      - name: Verify installations
        run: |
          echo "Checking installations..."
          python -c "import moviepy; print('‚úÖ MoviePy:', moviepy.__version__)"
          python -c "import yaml; print('‚úÖ PyYAML:', yaml.__version__)" || echo "‚ö†Ô∏è PyYAML check failed, trying to install..."
          pip install pyyaml --force-reinstall
          python -c "import yaml; print('‚úÖ PyYAML:', yaml.__version__)"
          python -c "from gtts import gTTS; print('‚úÖ gTTS installed')"
          python -c "from PIL import Image; print('‚úÖ Pillow installed')"
          ffmpeg -version | head -n 1

      # 8Ô∏è‚É£ Create placeholder background files (if not in repo)
      - name: Create placeholder media files
        run: |
          # Create background video if it doesn't exist
          if [ ! -f "background.mp4" ]; then
            echo "Creating placeholder background video..."
            python -c "
          from moviepy.editor import ColorClip
          import numpy as np
          # Create a gradient background
          clip = ColorClip(size=(1920, 1080), color=(20, 20, 60), duration=60)
          clip.write_videofile('background.mp4', fps=30, codec='libx264', audio=False, logger=None)
          print('‚úÖ Background video created')
            "
          fi
          
          # Create placeholder OM Mantra audio if it doesn't exist
          if [ ! -f "om_mantra.mp3" ]; then
            echo "‚ö†Ô∏è om_mantra.mp3 not found. Please add your OM Mantra audio file."
            echo "Creating silent placeholder..."
            python -c "
          from moviepy.editor import AudioClip
          import numpy as np
          # Create 5 minutes of silence as placeholder
          audio = AudioClip(lambda t: 0, duration=300, fps=44100)
          audio.write_audiofile('om_mantra.mp3', logger=None)
            "
          fi

      # 9Ô∏è‚É£ Generate videos
      - name: Generate daily content
        env:
          HUGGINGFACE_API_KEY: ${{ secrets.HUGGINGFACE_API_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          echo "üé¨ Starting FREE content generation..."
          python main.py

      # üîü Upload to platforms (if enabled)
      - name: Upload to social media
        env:
          YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
          YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
          YOUTUBE_REFRESH_TOKEN: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}
          INSTAGRAM_ACCESS_TOKEN: ${{ secrets.INSTAGRAM_ACCESS_TOKEN }}
          INSTAGRAM_USER_ID: ${{ secrets.INSTAGRAM_USER_ID }}
          TIKTOK_ACCESS_TOKEN: ${{ secrets.TIKTOK_ACCESS_TOKEN }}
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }}
        run: |
          echo "üöÄ Starting upload process..."
          python upload.py
        continue-on-error: true  # Don't fail workflow if upload fails

      # 1Ô∏è‚É£1Ô∏è‚É£ Upload videos as artifacts
      - name: Upload generated videos
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: astrofinance-videos-${{ github.run_number }}
          path: videos/
          retention-days: 7

      # 1Ô∏è‚É£2Ô∏è‚É£ Upload metadata
      - name: Upload metadata
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: metadata-${{ github.run_number }}
          path: |
            videos/metadata.json
            videos/upload_results.json
          retention-days: 30

      # 1Ô∏è‚É£3Ô∏è‚É£ Clean up temp files
      - name: Cleanup
        if: always()
        run: |
          rm -rf temp/
          echo "‚úÖ Cleanup complete"

      # 1Ô∏è‚É£4Ô∏è‚É£ Summary
      - name: Workflow summary
        if: always()
        run: |
          echo "## üåü AstroFinance Daily Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìÖ **Date:** $(date +'%B %d, %Y')" >> $GITHUB_STEP_SUMMARY
          echo "‚è∞ **Run Time:** $(date +'%H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "videos/metadata.json" ]; then
            echo "‚úÖ **Videos Generated Successfully**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üì∫ YouTube long-form video: Ready" >> $GITHUB_STEP_SUMMARY
            echo "üì± Short-form content: Ready" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Video Generation Failed**" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üì• **Download videos from Artifacts section below**" >> $GITHUB_STEP_SUMMARY
