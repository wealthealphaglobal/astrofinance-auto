name: Auto-Generate & Upload Videos for All Zodiac Signs

on:
  schedule:
    - cron: '0 20 * * *'  # Daily at 6 AM AEDT
  workflow_dispatch:
    inputs:
      auto_upload:
        description: 'Auto upload to YouTube?'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: read

jobs:
  process-signs:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        sign: [Aries, Taurus, Gemini, Cancer, Leo, Virgo, Libra, Scorpio, Sagittarius, Capricorn, Aquarius, Pisces]
      max-parallel: 12
    continue-on-error: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg imagemagick
          sudo sed -i '/<policy domain="path" rights="none" pattern="@\*"/d' /etc/ImageMagick-6/policy.xml
          python -m pip install --upgrade pip
          pip install moviepy==1.0.3 gTTS requests Pillow imageio imageio-ffmpeg pyyaml
          pip install google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client pytz

      - name: Setup media
        run: |
          mkdir -p videos/youtube_shorts/ videos/instagram_reels/
          if [ ! -f "background.mp4" ]; then
            python -c "from moviepy.editor import ColorClip; clip = ColorClip(size=(1080, 1920), color=(10, 10, 40), duration=60); clip.write_videofile('background.mp4', fps=30, codec='libx264', audio=False, logger=None)"
          fi
          if [ ! -f "om_mantra.mp3" ]; then
            python -c "from moviepy.editor import AudioClip; audio = AudioClip(lambda t: 0, duration=300, fps=44100); audio.write_audiofile('om_mantra.mp3', logger=None)"
          fi

      # ==================== GENERATE ====================
      - name: Generate ${{ matrix.sign }} video
        id: generate
        env:
          HUGGINGFACE_API_KEY: ${{ secrets.HUGGINGFACE_API_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          if python generate_short.py --sign "${{ matrix.sign }}" > /tmp/generate_${{ matrix.sign }}.log 2>&1; then
            echo "GENERATED_${{ matrix.sign }}=true" >> $GITHUB_ENV
            echo "âœ… ${{ matrix.sign }} generated"
          else
            echo "GENERATED_${{ matrix.sign }}=false" >> $GITHUB_ENV
            echo "âŒ ${{ matrix.sign }} generation failed"
            cat /tmp/generate_${{ matrix.sign }}.log
          fi

      # ==================== UPLOAD ====================
      - name: Upload ${{ matrix.sign }} to YouTube
        id: upload
        env:
          YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
          YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
          YOUTUBE_REFRESH_TOKEN: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}
          GENERATED_STATUS: ${{ env.GENERATED_${{ matrix.sign }} }}
        run: |
          if [ "${{ env.GENERATED_STATUS }}" = "true" ]; then
            if python upload_youtube.py --sign "${{ matrix.sign }}" --shorts --no-cleanup > /tmp/upload_${{ matrix.sign }}.log 2>&1; then
              YOUTUBE_URL=$(grep "ðŸ”— URL:" /tmp/upload_${{ matrix.sign }}.log | tail -n 1 | sed 's/.*ðŸ”— URL: //')
              echo "UPLOADED_${{ matrix.sign }}=true" >> $GITHUB_ENV
              echo "URL_${{ matrix.sign }}=$YOUTUBE_URL" >> $GITHUB_ENV
              echo "âœ… ${{ matrix.sign }} uploaded: $YOUTUBE_URL"
            else
              echo "UPLOADED_${{ matrix.sign }}=false" >> $GITHUB_ENV
              echo "âŒ ${{ matrix.sign }} upload failed"
              cat /tmp/upload_${{ matrix.sign }}.log
            fi
          else
            echo "UPLOADED_${{ matrix.sign }}=false" >> $GITHUB_ENV
            echo "â­ï¸ Skipped upload for ${{ matrix.sign }}"
          fi

      # ==================== DELETE ====================
      - name: Delete ${{ matrix.sign }} files
        env:
          UPLOADED_STATUS: ${{ env.UPLOADED_${{ matrix.sign }} }}
        run: |
          if [ "${{ env.UPLOADED_STATUS }}" = "true" ]; then
            rm -f videos/youtube_shorts/${{ matrix.sign }}_*.mp4
            rm -f videos/instagram_reels/${{ matrix.sign }}_*.mp4
            echo "ðŸ—‘ï¸ Deleted ${{ matrix.sign }} files"
          fi

      # ==================== SAVE RESULTS ====================
      - name: Save results
        if: always()
        run: |
          mkdir -p /tmp/results
          echo "${{ env.GENERATED_${{ matrix.sign }} }}" > /tmp/results/GENERATED_${{ matrix.sign }}
          echo "${{ env.UPLOADED_${{ matrix.sign }} }}" > /tmp/results/UPLOADED_${{ matrix.sign }}
          echo "${{ env.URL_${{ matrix.sign }} }}" > /tmp/results/URL_${{ matrix.sign }}

      - name: Upload results artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: results-${{ matrix.sign }}
          path: /tmp/results/
          retention-days: 1

  # ==================== EMAIL NOTIFICATION ====================
  send-email:
    runs-on: ubuntu-latest
    needs: process-signs
    if: always()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests

      - name: Download all results
        uses: actions/download-artifact@v4
        with:
          path: all_results

      - name: Compile email data
        id: compile
        run: |
          python3 << 'EOF'
          import os
          import glob
          
          SIGNS = ['Aries', 'Taurus', 'Gemini', 'Cancer', 'Leo', 'Virgo', 'Libra', 'Scorpio', 'Sagittarius', 'Capricorn', 'Aquarius', 'Pisces']
          
          generated = []
          uploaded = []
          failed = []
          urls = {}
          
          for sign in SIGNS:
              gen_file = f"all_results/results-{sign}/GENERATED_{sign}"
              up_file = f"all_results/results-{sign}/UPLOADED_{sign}"
              url_file = f"all_results/results-{sign}/URL_{sign}"
              
              gen_status = "false"
              up_status = "false"
              
              if os.path.exists(gen_file):
                  with open(gen_file) as f:
                      gen_status = f.read().strip()
              
              if os.path.exists(up_file):
                  with open(up_file) as f:
                      up_status = f.read().strip()
              
              if gen_status == "true":
                  generated.append(sign)
              
              if up_status == "true":
                  uploaded.append(sign)
                  if os.path.exists(url_file):
                      with open(url_file) as f:
                          url = f.read().strip()
                          if url:
                              urls[sign] = url
              
              if gen_status == "false" or up_status == "false":
                  failed.append(sign)
          
          # Output for GitHub Actions
          with open('EMAIL_DATA.txt', 'w') as f:
              f.write(f"GENERATED={','.join(generated)}\n")
              f.write(f"UPLOADED={','.join([f'{s}:{urls.get(s, '')}' for s in uploaded])}\n")
              f.write(f"FAILED={','.join(failed)}\n")
              f.write(f"STATUS={'success' if not failed else 'failure'}\n")
          
          print("Generated:", ','.join(generated))
          print("Uploaded:", ','.join([f'{s}' for s in uploaded]))
          print("Failed:", ','.join(failed))
          EOF
          
          cat EMAIL_DATA.txt >> $GITHUB_ENV

      - name: Send email report
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
        run: |
          python send_email.py \
            --status "${{ env.STATUS }}" \
            --generated "${{ env.GENERATED }}" \
            --uploaded "${{ env.UPLOADED }}" \
            --failed "${{ env.FAILED }}"
