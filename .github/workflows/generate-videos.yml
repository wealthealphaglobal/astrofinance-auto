name: Auto-Generate & Upload Videos for All Zodiac Signs

on:
  schedule:
    - cron: '0 20 * * *'  # Daily at 6 AM AEDT
  workflow_dispatch:
    inputs:
      auto_upload:
        description: 'Auto upload to YouTube?'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: read

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      generated_signs: ${{ steps.collect.outputs.generated }}
      uploaded_signs: ${{ steps.collect.outputs.uploaded }}
      failed_signs: ${{ steps.collect.outputs.failed }}
    steps:
      - name: Initialize tracking
        run: |
          mkdir -p workflow_data
          echo "" > workflow_data/generated.txt
          echo "" > workflow_data/uploaded.txt
          echo "" > workflow_data/failed.txt

  process-signs:
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      matrix:
        sign: [Aries, Taurus, Gemini, Cancer, Leo, Virgo, Libra, Scorpio, Sagittarius, Capricorn, Aquarius, Pisces]
    continue-on-error: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg imagemagick
          sudo sed -i '/<policy domain="path" rights="none" pattern="@\*"/d' /etc/ImageMagick-6/policy.xml
          python -m pip install --upgrade pip
          pip install moviepy==1.0.3 gTTS requests Pillow imageio imageio-ffmpeg pyyaml
          pip install google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client pytz

      - name: Setup media
        run: |
          mkdir -p videos/youtube_shorts/ videos/instagram_reels/
          if [ ! -f "background.mp4" ]; then
            python -c "from moviepy.editor import ColorClip; clip = ColorClip(size=(1080, 1920), color=(10, 10, 40), duration=60); clip.write_videofile('background.mp4', fps=30, codec='libx264', audio=False, logger=None)"
          fi
          if [ ! -f "om_mantra.mp3" ]; then
            python -c "from moviepy.editor import AudioClip; audio = AudioClip(lambda t: 0, duration=300, fps=44100); audio.write_audiofile('om_mantra.mp3', logger=None)"
          fi

      # ==================== GENERATE ====================
      - name: Generate ${{ matrix.sign }} video
        id: generate
        env:
          HUGGINGFACE_API_KEY: ${{ secrets.HUGGINGFACE_API_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          if python generate_short.py --sign "${{ matrix.sign }}" 2>&1 | tee generate_${{ matrix.sign }}.log; then
            echo "generated=true" >> $GITHUB_OUTPUT
            echo "${{ matrix.sign }}" >> workflow_data/generated.txt
          else
            echo "generated=false" >> $GITHUB_OUTPUT
            echo "${{ matrix.sign }}" >> workflow_data/failed.txt
            exit 1
          fi

      # ==================== UPLOAD ====================
      - name: Upload ${{ matrix.sign }} to YouTube
        if: steps.generate.outcome == 'success'
        id: upload
        env:
          YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
          YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
          YOUTUBE_REFRESH_TOKEN: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}
        run: |
          if python upload_youtube.py --sign "${{ matrix.sign }}" --shorts --no-cleanup 2>&1 | tee upload_${{ matrix.sign }}.log; then
            echo "uploaded=true" >> $GITHUB_OUTPUT
            # Extract YouTube URL
            YOUTUBE_URL=$(grep "ðŸ”— URL:" upload_${{ matrix.sign }}.log | tail -n 1 | sed 's/.*ðŸ”— URL: //')
            echo "url=$YOUTUBE_URL" >> $GITHUB_OUTPUT
            echo "${{ matrix.sign }}:$YOUTUBE_URL" >> workflow_data/uploaded.txt
          else
            echo "uploaded=false" >> $GITHUB_OUTPUT
            echo "${{ matrix.sign }}" >> workflow_data/failed.txt
            exit 1
          fi

      # ==================== DELETE ====================
      - name: Delete ${{ matrix.sign }} files
        if: steps.upload.outcome == 'success'
        run: |
          rm -f videos/youtube_shorts/${{ matrix.sign }}_*.mp4
          rm -f videos/instagram_reels/${{ matrix.sign }}_*.mp4

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ matrix.sign }}
          path: |
            generate_${{ matrix.sign }}.log
            upload_${{ matrix.sign }}.log
          retention-days: 1

      - name: Persist tracking data
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: workflow-data
          path: workflow_data/
          retention-days: 1

  # ==================== EMAIL NOTIFICATION ====================
  send-email:
    runs-on: ubuntu-latest
    needs: process-signs
    if: always()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install email dependencies
        run: pip install requests

      - name: Download tracking data
        uses: actions/download-artifact@v4
        with:
          name: workflow-data
          path: workflow_data/

      - name: Prepare email data
        id: email_data
        run: |
          GENERATED=$(grep -v '^$' workflow_data/generated.txt 2>/dev/null | tr '\n' ',' | sed 's/,$//')
          UPLOADED=$(grep -v '^$' workflow_data/uploaded.txt 2>/dev/null | tr '\n' ',' | sed 's/,$//')
          FAILED=$(grep -v '^$' workflow_data/failed.txt 2>/dev/null | tr '\n' ',' | sed 's/,$//')
          
          if [ -z "$FAILED" ]; then
            STATUS="success"
          else
            STATUS="failure"
          fi
          
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "generated=$GENERATED" >> $GITHUB_OUTPUT
          echo "uploaded=$UPLOADED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT

      - name: Send email report
        env:
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
        run: |
          python send_email.py \
            --status "${{ steps.email_data.outputs.status }}" \
            --generated "${{ steps.email_data.outputs.generated }}" \
            --uploaded "${{ steps.email_data.outputs.uploaded }}" \
            --failed "${{ steps.email_data.outputs.failed }}"
