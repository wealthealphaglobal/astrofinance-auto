name: Auto-Generate & Upload Videos for All Zodiac Signs

on:
  schedule:
    - cron: '0 12 * * *'  # Daily at 6 AM AEDT
  workflow_dispatch:
    inputs:
      auto_upload:
        description: 'Auto upload to YouTube?'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      skip_generation:
        description: 'Skip video generation & upload (test email only)?'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: read

jobs:
  process-signs:
    if: github.event.inputs.skip_generation != 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        sign: [Aries, Taurus, Gemini, Cancer, Leo, Virgo, Libra, Scorpio, Sagittarius, Capricorn, Aquarius, Pisces]
      max-parallel: 12
    continue-on-error: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg imagemagick
          sudo sed -i '/<policy domain="path" rights="none" pattern="@\*"/d' /etc/ImageMagick-6/policy.xml
          python -m pip install --upgrade pip
          pip install moviepy==1.0.3 gTTS requests Pillow imageio imageio-ffmpeg pyyaml
          pip install google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client pytz

      - name: Setup media
        run: |
          mkdir -p videos/youtube_shorts/ videos/instagram_reels/
          if [ ! -f "background.mp4" ]; then
            python -c "from moviepy.editor import ColorClip; clip = ColorClip(size=(1080, 1920), color=(10, 10, 40), duration=60); clip.write_videofile('background.mp4', fps=30, codec='libx264', audio=False, logger=None)"
          fi
          if [ ! -f "om_mantra.mp3" ]; then
            python -c "from moviepy.editor import AudioClip; audio = AudioClip(lambda t: 0, duration=300, fps=44100); audio.write_audiofile('om_mantra.mp3', logger=None)"
          fi

      # ==================== GENERATE ====================
      - name: Generate ${{ matrix.sign }} video
        run: |
          python generate_short.py --sign "${{ matrix.sign }}" 2>&1 | tee /tmp/generate.log
          if [ ${PIPESTATUS[0]} -eq 0 ]; then
            echo "GENERATE_SUCCESS=true" >> $GITHUB_ENV
            echo "âœ… ${{ matrix.sign }} generated"
          else
            echo "GENERATE_SUCCESS=false" >> $GITHUB_ENV
            echo "âŒ ${{ matrix.sign }} generation failed"
          fi
        env:
          HUGGINGFACE_API_KEY: ${{ secrets.HUGGINGFACE_API_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}

      # ==================== UPLOAD ====================
      - name: Upload ${{ matrix.sign }} to YouTube
        run: |
          if [ "${{ github.event.inputs.auto_upload }}" = "false" ]; then
            echo "â­ï¸ SKIPPED: YouTube upload disabled"
            echo "UPLOAD_SUCCESS=false" >> $GITHUB_ENV
            echo "YOUTUBE_URL=" >> $GITHUB_ENV
          elif [ "$GENERATE_SUCCESS" = "true" ]; then
            python upload_youtube.py --sign "${{ matrix.sign }}" --shorts --no-cleanup 2>&1 | tee /tmp/upload.log
            if [ ${PIPESTATUS[0]} -eq 0 ]; then
              YOUTUBE_URL=$(grep "ðŸ”— URL:" /tmp/upload.log | tail -n 1 | sed 's/.*ðŸ”— URL: //')
              echo "UPLOAD_SUCCESS=true" >> $GITHUB_ENV
              echo "YOUTUBE_URL=$YOUTUBE_URL" >> $GITHUB_ENV
              echo "âœ… ${{ matrix.sign }} uploaded: $YOUTUBE_URL"
            else
              echo "UPLOAD_SUCCESS=false" >> $GITHUB_ENV
              echo "âŒ ${{ matrix.sign }} upload failed"
            fi
          else
            echo "UPLOAD_SUCCESS=false" >> $GITHUB_ENV
            echo "â­ï¸ Skipped upload (generation failed)"
          fi
        env:
          YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
          YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
          YOUTUBE_REFRESH_TOKEN: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}

      # ==================== DELETE ====================
      - name: Delete ${{ matrix.sign }} files
        if: success()
        run: |
          rm -f videos/youtube_shorts/${{ matrix.sign }}_*.mp4
          rm -f videos/instagram_reels/${{ matrix.sign }}_*.mp4
          echo "ðŸ—‘ï¸ Deleted ${{ matrix.sign }} files"

      # ==================== SAVE RESULTS ====================
      - name: Save results
        if: always()
        run: |
          mkdir -p /tmp/results
          echo "${{ matrix.sign }}" > /tmp/results/sign.txt
          echo "$GENERATE_SUCCESS" > /tmp/results/generate.txt
          echo "$UPLOAD_SUCCESS" > /tmp/results/upload.txt
          echo "$YOUTUBE_URL" > /tmp/results/url.txt

      - name: Upload results artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: results-${{ matrix.sign }}
          path: /tmp/results/
          retention-days: 1

  # ==================== EMAIL NOTIFICATION ====================
  send-email:
    runs-on: ubuntu-latest
    needs: process-signs
    if: always()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client

      # ==================== TEST MODE: Skip to email directly ====================
      - name: Test Email Mode (Skip Generation)
        if: github.event.inputs.skip_generation == 'true'
        env:
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          GMAIL_ADDRESS: ${{ secrets.GMAIL_ADDRESS }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        run: |
          echo "ðŸ§ª TEST MODE: Skipping generation, sending test email..."
          python send_email.py \
            --status "success" \
            --generated "Aries,Taurus,Gemini" \
            --uploaded "Aries:https://youtube.com/watch?v=test1,Taurus:https://youtube.com/watch?v=test2" \
            --failed "Cancer,Leo"

      # ==================== NORMAL MODE: Compile results from jobs ====================
      - name: Download all results (Normal Mode)
        if: github.event.inputs.skip_generation != 'true'
        uses: actions/download-artifact@v4
        with:
          path: all_results

      - name: Compile and send email (Normal Mode)
        if: github.event.inputs.skip_generation != 'true'
        env:
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          GMAIL_ADDRESS: ${{ secrets.GMAIL_ADDRESS }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        run: |
          python3 << 'EOF'
          import os
          import subprocess
          
          SIGNS = ['Aries', 'Taurus', 'Gemini', 'Cancer', 'Leo', 'Virgo', 'Libra', 'Scorpio', 'Sagittarius', 'Capricorn', 'Aquarius', 'Pisces']
          
          generated = []
          uploaded_with_urls = []
          failed = []
          
          for sign in SIGNS:
              result_dir = f"all_results/results-{sign}"
              
              if not os.path.exists(result_dir):
                  failed.append(sign)
                  continue
              
              gen_file = f"{result_dir}/generate.txt"
              up_file = f"{result_dir}/upload.txt"
              url_file = f"{result_dir}/url.txt"
              
              gen_status = "false"
              up_status = "false"
              url = ""
              
              if os.path.exists(gen_file):
                  with open(gen_file) as f:
                      gen_status = f.read().strip()
              
              if os.path.exists(up_file):
                  with open(up_file) as f:
                      up_status = f.read().strip()
              
              if os.path.exists(url_file):
                  with open(url_file) as f:
                      url = f.read().strip()
              
              if gen_status == "true":
                  generated.append(sign)
              
              if up_status == "true":
                  uploaded_with_urls.append(f"{sign}:{url}")
              
              if gen_status != "true" or up_status != "true":
                  failed.append(sign)
          
          # Call send_email.py
          status = "success" if not failed else "failure"
          generated_str = ",".join(generated)
          uploaded_str = ",".join(uploaded_with_urls)
          failed_str = ",".join(failed)
          
          cmd = [
              "python", "send_email.py",
              "--status", status,
              "--generated", generated_str,
              "--uploaded", uploaded_str,
              "--failed", failed_str
          ]
          
          result = subprocess.run(cmd)
          exit(result.returncode)
          EOF
